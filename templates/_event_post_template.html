{# templates/_event_post_template.html #}
{% if post %}
    {# NEW: Define search text logic for filtering #}
    {% if post.event and not post.content and not post.media_files %}
        {# This is an event card (like the announcement) #}
        {% set original_post = post.event %} 
        {% set search_text = (original_post.title or '') | lower + ' ' + (original_post.creator_display_name or '') | lower + ' ' + (original_post.location or '') | lower %}
    {% else %}
        {# This is a regular post on the event wall #}
        {% set original_post = post %} 
        {% set search_text = ((original_post.content or '') + ' ' + (original_post.author.display_name or '') + ' ' + (original_post.author.username or '')) | lower %}
    {% endif %}

    <!-- NEW: Added 'event-post-item' class and 'data-search-text' attribute -->
<div class="p-4 rounded-lg shadow-sm border post-card event-post-item" id="post-{{ post.cuid }}" data-search-text="{{ search_text | e }}">
    <div class="flex justify-between items-start mb-1">
        <div class="flex items-start gap-2 flex-1 min-w-0">
            <!-- Profile Picture (fixed, doesn't wrap) -->
            <div class="flex-shrink-0">
                {% if post.author.profile_picture_path %}
                    {% if post.author.hostname %}
                        {% set insecure_mode = config.get('FEDERATION_INSECURE_MODE', False) %}
                        {% set protocol = 'http' if insecure_mode else 'https' %}
                        <img src="{{ protocol }}://{{ post.author.hostname }}/profile_pictures/{{ post.author.profile_picture_path }}" 
                             alt="Profile Picture" 
                             class="w-10 h-10 rounded-full object-cover"
                             onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}';">
                    {% else %}
                        <img src="{{ url_for('main.serve_profile_picture', filename=post.author.profile_picture_path) }}" 
                             alt="Profile Picture" 
                             class="w-10 h-10 rounded-full object-cover"
                             onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}';">
                    {% endif %}
                {% else %}
                    <img src="{{ url_for('static', filename='images/default_avatar.png') }}" 
                         alt="Profile Picture" 
                         class="w-10 h-10 rounded-full object-cover">
                {% endif %}
            </div>
            
            <!-- Text Content (wraps within this container) -->
            <div class="flex-1 min-w-0">
                <p class="text-sm secondary-text flex items-baseline flex-wrap gap-x-1">
                    <a href="{{ federated_user_profile_url(post.author) }}" class="name-link">
                        {{ post.author.display_name }}
                    </a>
                    
                    {# NEW: Display tagged users #}
                    {% if post.tagged_user_puids %}
                        {% set tagged_puids = post.tagged_user_puids|from_json if post.tagged_user_puids is string else post.tagged_user_puids %}
                        {% if tagged_puids and tagged_puids|length > 0 %}
                            <span class="secondary-text">is with</span>
                            {% if tagged_puids|length == 1 %}
                                {# Single tagged user #}
                                {% set tagged_user = get_user_by_puid(tagged_puids[0]) %}
                                {% if tagged_user %}
                                    <a href="{{ federated_user_profile_url(tagged_user) }}" class="name-link">
                                        {{ tagged_user.display_name }}
                                    </a>
                                {% endif %}
                            {% elif tagged_puids|length == 2 %}
                                {# Two tagged users: "Name1 and Name2" #}
                                {% set tagged_user_1 = get_user_by_puid(tagged_puids[0]) %}
                                {% set tagged_user_2 = get_user_by_puid(tagged_puids[1]) %}
                                {% if tagged_user_1 %}
                                    <a href="{{ federated_user_profile_url(tagged_user_1) }}" class="name-link">
                                        {{ tagged_user_1.display_name }}
                                    </a>
                                {% endif %}
                                <span class="secondary-text">and</span>
                                {% if tagged_user_2 %}
                                    <a href="{{ federated_user_profile_url(tagged_user_2) }}" class="name-link">
                                        {{ tagged_user_2.display_name }}
                                    </a>
                                {% endif %}
                            {% else %}
                                {# Three or more: "Name1 and X others" #}
                                {% set tagged_user = get_user_by_puid(tagged_puids[0]) %}
                                {% if tagged_user %}
                                    <a href="{{ federated_user_profile_url(tagged_user) }}" class="name-link">
                                        {{ tagged_user.display_name }}
                                    </a>
                                {% endif %}
                                <span class="secondary-text">and</span>
                                <a href="#" onclick="showTaggedPeopleModal('{{ post.cuid }}', event); return false;" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                                    {{ tagged_puids|length - 1 }} other{{ 's' if (tagged_puids|length - 1) > 1 else '' }}
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    
                    {# NEW: Display location #}
                    {% if post.location %}
                        <span class="secondary-text">at</span>
                        <a href="https://www.google.com/maps/search/{{ post.location | urlencode }}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                            {{ post.location }}
                        </a>
                    {% endif %}
                    
                    {% if post.event and (post.content or post.media_files) %}
                        <span>&#9658;</span>
                        <a href="{{ url_for('events.event_profile', puid=post.event.puid) }}" class="name-link">
                            {{ post.event.title }}
                        </a>
                    {% endif %}
                </p>
                
                <!-- Timestamp on its own line -->
                <a href="{{ url_for('main.view_post', cuid=post.cuid) }}" class="hover:underline">
                    <span class="text-xs secondary-text utc-timestamp" data-timestamp="{{ post.timestamp }}">
                        {{ post.timestamp | format_timestamp }}
                    </span>
                </a>
            </div>
        </div>
        
        {# NEW: Define permissions for event posts #}
        {% set is_post_author = current_user_puid == post.author.puid %}
        {# 'is_creator' is passed in from event_profile.html, checking if viewer created the EVENT #}
        {% set can_edit_post = is_post_author %}
        {% set can_delete_post = is_post_author or is_creator or session.get('is_admin') %}
        {# MODIFICATION: Event creator ('is_creator') can now disable comments #}
        {% set can_disable_comments = is_post_author or is_creator or session.get('is_admin') %}
        {# NEW: Define permission for friend actions (snooze/block) #}
        {% set show_friend_options = current_user_puid and post.author.puid != current_user_puid and post.author.puid in friend_puids %}

        {% if can_edit_post or can_delete_post or can_disable_comments or show_friend_options %}
        <div class="relative inline-block text-left">
            <button type="button" class="inline-flex justify-center w-full rounded-md px-2 py-1 text-sm font-medium secondary-text hover:bg-gray-100 dark:hover:bg-gray-700" onclick="toggleDropdown(event, 'dropdown-menu-event-post-{{ post.cuid }}')">
                <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
            </button>
            <div class="dropdown-menu" id="dropdown-menu-event-post-{{ post.cuid }}">
                <div class="py-1">
                    {% if can_edit_post %}
                       <button onclick="openEditPostModal('{{ post.cuid }}', '{{ post.author.puid }}', '{{ post.content | js_string }}', '{{ post.privacy_setting }}', '{{ post.media_files | tojson | js_string }}', '{{ viewer_home_url }}', {{ 'true' if is_federated_viewer else 'false' }}, false, false, true, '{{ post.tagged_user_puids | js_string }}', '{{ post.location | js_string }}', {{ 'true' if current_user_requires_parental_approval else 'false' }})" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span>Edit</span>
                            </span>
                       </button>
                    {% endif %}
                    {% if can_delete_post %}
                    <form action="{{ url_for('main.delete_post_route', post_cuid=post.cuid) }}" method="POST" onsubmit="event.preventDefault();">
                        <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to delete this post?')" class="text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                <span>Delete</span>
                            </span>
                        </button>
                    </form>
                    {% endif %}
                    {# NEW: Add "Disable Comments" button for event posts #}
                    {% if can_disable_comments and not post.comments_disabled %}
                    <form action="{{ url_for('main.disable_comments_route', cuid=post.cuid) }}" method="POST" onsubmit="event.preventDefault();">
                        <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to permanently disable comments on this post? This cannot be undone.')" class="text-orange-600 dark:text-orange-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"></path>
                                </svg>
                                <span>Disable Comments</span>
                            </span>
                        </button>
                    </form>
                    {% endif %}
                    {# NEW: Snooze and Block options for friend posts #}
                    {% if show_friend_options %}
                        <form action="{{ url_for('friends.snooze_friend_route', puid=post.author.puid) }}" method="POST">
                            <button type="submit" class="hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                <span class="inline-flex items-center gap-2">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                    </svg>
                                    <span>Snooze {{ post.author.display_name or post.author.username }}</span>
                                </span>
                            </button>
                        </form>
                        <form action="{{ url_for('friends.block_friend_route', puid=post.author.puid) }}" method="POST" onsubmit="event.preventDefault();">
                            <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to block {{ post.author.display_name or post.author.username | js_string }}? You will no longer see their posts and they will not be able to interact with your content.')" class="text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                <span class="inline-flex items-center gap-2">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                            <path fill-rule="evenodd" 
                                                d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" 
                                                clip-rule="evenodd"/>
                                    </svg>
                                    <span>Block {{ post.author.display_name or post.author.username }}</span>
                                </span>
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if post.event and not post.content and not post.media_files %}
        <div class="mt-4">
            {% with event=post.event, current_user_puid=current_user_puid %}
                {% include '_event_card.html' %}
            {% endwith %}
        </div>
    {% else %}
        {# Event posts always process @everyone styling #}
        {% set processed_content = post.content | default('', true) | linkify_mentions | linkify_urls %}
        <p class="primary-text whitespace-pre-wrap">{{ processed_content | replace('@everyone', '<span class="font-bold text-orange-600 dark:text-orange-400">@everyone</span>') | replace('@all', '<span class="font-bold text-orange-600 dark:text-orange-400">@all</span>') | safe }}</p>
    {% endif %}

    {% if post.media_files %}
        <div class="mt-2 media-grid {% if post.media_files|length > 1 %}grid-cols-2{% endif %}" id="media-grid-{{ post.cuid }}">
            {% for media_file in post.media_files %}
                {# Show first 4 photos by default, hide the rest #}
                {% set is_hidden = loop.index > 4 %}
                <a href="{{ url_for('main.view_media', muid=media_file.muid) }}" 
                id="media-{{ media_file.muid }}" 
                class="post-media-item-link {% if is_hidden %}extra-media hidden{% endif %}"
                data-post-cuid="{{ post.cuid }}">
                <div class="post-media-item" data-media-id="{{ media_file.id }}" data-muid="{{ media_file.muid }}" data-media-url="{{ federated_media_url(post.author, media_file.media_file_path) }}" data-media-type="{% if media_file.media_file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp')) %}image{% elif media_file.media_file_path.lower().endswith(('.mp4', '.mov', '.webm', '.avi', '.mkv')) %}video{% else %}other{% endif %}" data-alt-text="{{ media_file.alt_text | default('') }}" data-username="{{ post.author.username }}" data-puid="{{ post.author.puid }}" data-media-index="{{ loop.index0 }}" data-origin-hostname="{{ media_file.origin_hostname or '' }}">
                    {% if media_file.media_file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp')) %}
                        {# Use thumbnails for all images - construct appropriate URL based on origin #}
                        {% set media_url = federated_media_url(post.author, media_file.media_file_path) %}
                        {% if media_file.origin_hostname and media_file.origin_hostname != config.get('NODE_HOSTNAME') %}
                            {# Remote media - construct federated thumbnail URL #}
                            {% set insecure_mode = config.get('FEDERATION_INSECURE_MODE', False) %}
                            {% set protocol = 'http' if insecure_mode else 'https' %}
                            {% set thumb_url = protocol ~ '://' ~ media_file.origin_hostname ~ '/thumbnails/' ~ post.author.puid ~ '/' ~ media_file.media_file_path %}
                        {% else %}
                            {# Local media - use local thumbnail route #}
                            {% set thumb_url = url_for('main.serve_thumbnail',
                                puid=post.author.puid,
                                filename=media_file.media_file_path) %}
                        {% endif %}
                        <img src="{{ thumb_url }}"
                            alt="Post Media"
                            class="w-full h-full object-cover"
                            loading="lazy"
                            onerror="this.onerror=null; this.src='{{ media_url | e }}'">
                    {% elif media_file.media_file_path.lower().endswith(('.mp4', '.mov', '.webm', '.avi', '.mkv')) %}
                        <video preload="metadata" muted><source src="{{ federated_media_url(post.author, media_file.media_file_path) }}#t=0.1" type="video/mp4"></video>
                        <div class="play-icon">&#9658;</div>
                    {% endif %}
                </div>
            </a>
        {% endfor %}
            </div>
            
            {# Show More/Less buttons for photos #}
            {% if post.media_files|length > 4 %}
                <div class="media-toggle-container mt-2" id="media-toggle-{{ post.cuid }}">
                    <button type="button" 
                            class="show-more-media-button text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium"
                            onclick="App.MediaToggle.showMoreMedia('{{ post.cuid }}')"
                            data-post-cuid="{{ post.cuid }}">
                        Show {{ post.media_files|length - 4 }} more photo{% if post.media_files|length - 4 != 1 %}s{% endif %}
                    </button>
                    <button type="button" 
                            class="show-less-media-button text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium hidden"
                            onclick="App.MediaToggle.showLessMedia('{{ post.cuid }}')"
                            data-post-cuid="{{ post.cuid }}">
                        Show less
                    </button>
                </div>
            {% endif %}
        {% endif %}

    {# NEW: Poll Display #}
    <!-- DEBUG: post.poll exists = {{ 'YES' if post.poll else 'NO' }} -->
    {% if post.poll %}
        {# Use current_user_id which is already passed to this template #}
        {% with poll=post.poll %}
            {% include '_poll_display.html' %}
        {% endwith %}
    {% endif %}

    {# NEW: Link Preview Display #}
    {% if post.link_previews %}
        <div class="link-previews-container mt-3">
            {% for preview in post.link_previews %}
                {% include '_link_preview_card.html' %}
            {% endfor %}
        </div>
    {% endif %}
	
    {# --- NEW: Comment Count (moved and resized) --- #}
    <div class="text-xs mt-2 flex flex-col"> <!-- Removed text-gray-400 -->
        {% set total_comments = post.comments | count_all_comments %}
        <!-- MODIFICATION: Removed the opacity class -->
        <p class="flex items-center text-sm mt-1 primary-text">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            {% if total_comments > 0 %}
                <span>{{ total_comments }}</span>
            {% endif %}
        </p>
    </div>
    {# --- END NEW --- #}
    <div class="mt-6 border-t dark:border-gray-700 pt-4">
        <h3 class="text-lg font-semibold primary-text mb-3">Comments</h3>
        
        <!-- MODIFICATION: START -->
        <!-- Container for comments list and 'show more' button -->
        <div id="comments-container-{{ post.cuid }}">
            {% if post.comments %}
                <div class="space-y-4 comments-list">
                {% for comment in post.comments %}
                    {# *** MODIFICATION: Changed loop.index > 3 to loop.index > 1 *** #}
                    {% set comment_classes = 'extra-comment hidden' if loop.index > 1 else '' %}
                    
                    <div class="{{ comment_classes }}">
                        {# NEW: Pass comments_disabled status to the comment template #}
                        {# NEW: Pass public page owner status (is_creator checks if viewer created the EVENT, not if they own the page) #}
                        {# NEW: Pass event context for @everyone styling #}
                        {% set is_public_page_owner = (post.author.user_type == 'public_page' and post.author.puid == current_user_puid) %}
                        {% set is_event_context = True %}
                        {% set is_group_context = False %}
                        {# MODIFICATION: Pass is_creator (the event creator) down to the comment template #}
                        {% with post_cuid=post.cuid, current_username=session.username, is_admin=session.get('is_admin'), post_owner_id=post.profile_user_id, current_user_id=current_user_id, is_event_context=is_event_context, is_group_context=is_group_context, comments_disabled=post.comments_disabled, is_public_page_owner=is_public_page_owner, is_event_creator=is_creator, friend_puids=friend_puids %}
                            {% include '_comment_template.html' %}
                        {% endwith %}
                    </div>
                {% endfor %}
                </div>
                {# *** MODIFICATION: Changed post.comments | length > 3 to > 1 *** #}
                {% if post.comments | length > 1 %}
                    <button type="button" 
                            onclick="App.Comment.showMore(this, 'comments-container-{{ post.cuid }}', 'extra-comment')" 
                            class="text-sm font-semibold text-blue-500 dark:text-blue-400 hover:underline mt-2 show-more-button">
                        {# *** MODIFICATION: Updated button text logic *** #}
                        {% set remaining_comments = post.comments | length - 1 %}
                        View {{ remaining_comments }} more {{ 'comment' if remaining_comments == 1 else 'comments' }}
                    </button>
                {% endif %}
            {% else %}
                <p class="secondary-text">No comments yet.</p>
            {% endif %}
        </div>
        <!-- MODIFICATION: END -->

        {# NEW: Check if comments are disabled #}
        {% if not post.comments_disabled %}
            {# BUG FIX: Add comment form for attendees/creator on the event wall #}
            {% if post.event and (post.event.viewer_response in ['attending', 'tentative'] or current_user_puid == post.event.created_by_user_puid) and not post.event.is_cancelled %}
                <form id="commentForm-{{ post.cuid }}" action="{{ url_for('comments.add_comment_route', post_cuid=post.cuid) }}" method="POST" class="mb-4 mt-4 border-t dark:border-gray-700 pt-4">
                    <input type="hidden" name="parent_comment_id" class="parent-comment-id-input">
                    <div class="replying-to-display text-sm secondary-text mb-1 hidden">
                        Replying to <span class="font-semibold reply-to-username"></span>
                        <button type="button" onclick="hideReplyForm('{{ post.cuid }}')" class="text-red-500 hover:text-red-700 ml-2 text-xs">Cancel</button>
                    </div>
                    <textarea name="comment_content" placeholder="Add a comment..." rows="2" class="w-full p-2 border rounded-md mb-2 form-input"></textarea>
                    
                    <div class="mb-2" flex gap-2>
						<label for="comment-media-upload-{{ post.cuid }}" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out cursor-pointer inline-flex items-center gap-2">
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
							</svg>
							Upload Media
						</label>
						<input type="file" id="comment-media-upload-{{ post.cuid }}" accept="image/*,video/*" multiple class="hidden" onchange="handleCommentMediaUpload(event, '{{ post.cuid }}')">
						
                        <button type="button" onclick="openCommentMediaBrowser('{{ post.cuid }}', {{ 'true' if is_federated_viewer else 'false' }}, '{{ viewer_home_url }}')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out inline-flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-4 4 4 4-4V5h-2v4l-2-2-4 4-2-2-2 2z" clip-rule="evenodd"></path>
                            </svg>
                            Browse Media
                        </button>
                    </div>
                    <div id="comment-media-preview-{{ post.cuid }}" class="flex flex-wrap gap-2 mb-2"></div>
                    <input type="hidden" name="selected_comment_media_files" id="selected_comment_media_files-{{ post.cuid }}" value="[]">                    
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-200 inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Post Comment
                    </button>
                </form>
            {% elif post.event and not post.event.is_cancelled %}
                <p class="secondary-text mb-4 mt-4 border-t dark:border-gray-700 pt-4">You must be attending or interested in the event to comment.</p>
            {% endif %}
        {% else %}
            {# NEW: Show this message if comments are disabled #}
            <div class="p-3 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-center mb-4 disabled-comment-box mt-4">
                <p class="secondary-text font-medium text-sm">Comments are disabled for this post.</p>
            </div>
        {% endif %}

    </div>
</div>
{% endif %}