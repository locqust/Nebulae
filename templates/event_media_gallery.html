<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ event.title }} - Media Gallery</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <style>
        /* This part stays in the HTML because it's dynamically generated by the server */
        html {
            font-size: {{ user_settings.text_size | default(100) }}%;
        }
        
        .filter-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            background-color: var(--post-card-bg);
            color: var(--secondary-text);
            border: 1px solid var(--border-color);
        }
        
        .filter-button:hover {
            background-color: var(--hover-bg);
        }
        
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
    <script>
        // Immediately apply the theme to prevent flashing
        (function() {
            const theme = "{{ user_settings.theme | default('light') }}";
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="min-h-screen">
    <!-- Page Loader -->
    <div id="pageLoader" class="page-loader" style="display: flex;">
        <div class="loader-spinner"></div>
    </div>

    {% include '_header.html' %}

    <!-- Mobile Sidebar Toggle Button -->
    <button id="mobile-sidebar-toggle" type="button" aria-label="Toggle sidebar">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay"></div>
       
    <!-- Main Content Grid -->
    <div class="page-container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="lg:col-span-12 mb-4">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- Cancellation Banner -->
        {% if event.is_cancelled %}
            <div class="lg:col-span-12 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                <p class="font-bold">Event Cancelled</p>
                <p>This event has been cancelled and is no longer active.</p>
            </div>
        {% endif %}
        
        <!-- Grid Layout: Sidebar + Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Sidebar -->
            <aside class="lg:col-span-3 space-y-6">
                
                <!-- Event Picture Card -->
                <div class="p-6 rounded-lg shadow-sm border post-card">
                    <div class="flex flex-col items-center">
                        <div class="w-60 h-60 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                            {% if event.profile_picture_path %}
                                <img id="event-picture-display"
                                     src="{{ url_for('main.serve_event_picture', filename=event.profile_picture_path) }}"
                                     alt="Event Picture"
                                     class="w-full h-full object-cover">
                            {% else %}
                                <svg class="w-24 h-24 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            {% endif %}
                        </div>
                        
                        <div class="text-center mt-4">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors">{{ event.title }}</h1>
                            <p class="text-lg secondary-text">
                                Hosted by 
                                <a href="{{ federated_user_profile_url(creator) if event.source_type != 'group' else url_for('groups.group_profile', puid=creator.puid) }}" class="font-semibold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                    {{ event.creator_display_name }}
                                </a>
                            </p>
                        </div>
                        
                        {% if is_creator and not event.is_cancelled %}
                            <div class="mt-4 text-center flex flex-col gap-4 justify-center w-full">
                                <form id="eventPictureUploadForm" action="{{ url_for('events.upload_event_picture', puid=event.puid) }}" method="POST" enctype="multipart/form-data" class="flex flex-col items-center gap-2 w-full">
                                    <label for="event_picture_file_input" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out cursor-pointer inline-flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                                        </svg>
                                        Upload Media
                                        <input type="file" name="event_picture_file_input" id="event_picture_file_input" accept="image/png, image/jpeg, image/gif" class="hidden">
                                    </label>
                                    <input type="hidden" name="cropped_image_data" id="cropped_image_data">
                                    <input type="hidden" name="original_image_path_from_browser" id="original_image_path_from_browser">
                                </form>
                                {% if creator_media_path %}
                                <div class="flex flex-col items-center gap-2 w-full">
                                   <span class="block text-sm font-medium secondary-text">Or</span>
                                    <button type="button" onclick="openMediaBrowserForEventPicture()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-300 ease-in-out inline-flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-4 4 4 4-4V5h-2v4l-2-2-4 4-2-2-2 2z" clip-rule="evenodd"></path>
                                        </svg>
                                        Browse Media
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Event Details Card -->
                <div class="p-6 rounded-lg shadow-sm border post-card">
                    <h3 class="text-lg font-semibold primary-text mb-4">Event Details</h3>
                    <div class="space-y-3 secondary-text">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <div>
                                <p class="font-medium primary-text">{{ formatted_date }}</p>
                                {% if formatted_end_date %}
                                    <p class="text-sm secondary-text">to {{ formatted_end_date }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if event.location %}
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <p>{{ event.location }}</p>
                        </div>
                        {% endif %}
                        
                        {% if event.description %}
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            <p>{{ event.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Navigation Card -->
                <div class="p-4 rounded-lg shadow-sm border post-card">
                    <nav class="space-y-2">
                        <a href="{{ url_for('events.event_profile', puid=event.puid) }}" class="block py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors secondary-text hover:text-gray-900 dark:hover:text-white">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                <span class="font-medium">Event Home</span>
                            </div>
                        </a>
                        <a href="{{ url_for('events.event_attendees', puid=event.puid) }}" class="block py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors secondary-text hover:text-gray-900 dark:hover:text-white">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                <span class="font-medium">Attendees ({{ total_responses }})</span>
                            </div>
                        </a>
                        <a href="{{ url_for('events.event_media_gallery', puid=event.puid) }}" class="block py-2 px-4 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span class="font-medium">Media Gallery</span>
                            </div>
                        </a>
                        {% if is_creator and not event.is_cancelled %}
                        <a href="{{ url_for('events.event_settings', puid=event.puid) }}" class="block py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors secondary-text hover:text-gray-900 dark:hover:text-white">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span class="font-medium">Event Settings</span>
                            </div>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </aside>
            
            <!-- Main Content Area -->
            <main class="lg:col-span-9">
                <!-- Page Header -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold primary-text mb-2">Media Gallery</h2>
                    <p class="secondary-text">All photos and videos shared in {{ event.title }}</p>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button onclick="filterMedia('all')" class="filter-button active" data-filter="all">
                        All Media
                    </button>
                    <button onclick="filterMedia('images')" class="filter-button" data-filter="images">
                        Photos
                    </button>
                    <button onclick="filterMedia('videos')" class="filter-button" data-filter="videos">
                        Videos
                    </button>
                </div>
                
                <!-- Media Grid -->
                {% if all_media %}
                <div id="mediaGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for media_item in all_media %}
                    {% set author_obj = {'hostname': media_item.origin_hostname, 'puid': media_item.puid, 'username': media_item.username} %}
                    {% set media_url = federated_media_url(author_obj, media_item.media_file_path) %}
                    
                    <div class="media-item {{ 'image-item' if media_item.media_type == 'image' else 'video-item' }} relative group rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700 cursor-pointer hover:opacity-90 transition-opacity" 
                         data-media-type="{{ media_item.media_type }}"
                         onclick="openMediaCarousel({{ loop.index0 }})">
                        {% if media_item.media_type == 'image' %}
                                             {% set thumb_url = url_for('main.serve_thumbnail',
                                            puid=media_item.puid,
                                                filename=media_item.media_file_path) %}
                                                    <img src="{{ thumb_url }}"
                                                        alt="Post Media"
                                                        class="w-full h-full object-cover"
                                                        loading="lazy"
                                                        onerror="this.src='{{ media_url }}'">
                        {% else %}
                            <video class="w-full h-48 object-cover">
                                <source src="{{ media_url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                            </div>
                        {% endif %}
                        
                        <!-- Media Info Overlay -->
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <p class="text-white text-sm font-medium truncate">{{ media_item.username }}</p>
                            <p class="text-white text-xs">{{ media_item.timestamp }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 post-card rounded-lg">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <h3 class="mt-2 text-sm font-medium primary-text">No media yet</h3>
                    <p class="mt-1 text-sm secondary-text">Media shared in event posts will appear here.</p>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
    
    <!-- Image Cropper Modal (from event_profile.html) -->
    <div id="cropperModal" class="modal hidden">
        <div class="modal-content max-w-3xl">
            <span class="close-button" onclick="closeModal('cropperModal')">&times;</span>
            <h2 class="text-xl font-bold primary-text mb-4">Adjust Event Picture</h2>
            <div class="mb-4">
                <img id="cropperImage" style="max-width: 100%;">
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="applyCropAndUpload()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Upload</button>
                <button type="button" onclick="closeModal('cropperModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal (from event_profile.html) -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('settingsModal')">&times;</span>
            <h2 class="text-2xl font-bold primary-text mb-6">Settings</h2>
            
            <div class="space-y-4">
                <!-- Accordion Item 1: Appearance -->
                <div>
                    <button type="button" class="settings-accordion-button">
                        <span class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                            <div>
                                <span class="font-bold primary-text">Appearance</span>
                                <p class="text-sm secondary-text font-normal">Customize your viewing experience.</p>
                            </div>
                        </span>
                        <svg class="accordion-icon w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-accordion-panel">
                        <div class="space-y-4 pt-4">
                            <div>
                                <label for="themeSelect" class="block text-sm font-medium secondary-text mb-2">Theme</label>
                                <select id="themeSelect" class="form-input w-full">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                            </div>
                            <div>
                                <label for="textSizeSelect" class="block text-sm font-medium secondary-text mb-2">Text Size</label>
                                <select id="textSizeSelect" class="form-input w-full">
                                    <option value="75">Small (75%)</option>
                                    <option value="87.5">Medium-Small (87.5%)</option>
                                    <option value="100">Normal (100%)</option>
                                    <option value="112.5">Medium-Large (112.5%)</option>
                                    <option value="125">Large (125%)</option>
                                </select>
                            </div>
                            <div>
                                <label for="timezoneSelect" class="block text-sm font-medium secondary-text mb-2">Timezone</label>
                                <select id="timezoneSelect" class="form-input w-full">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time</option>
                                    <option value="America/Chicago">Central Time</option>
                                    <option value="America/Denver">Mountain Time</option>
                                    <option value="America/Los_Angeles">Pacific Time</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                    <option value="Australia/Sydney">Sydney</option>
                                </select>
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Save Appearance Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 2: Account Settings -->
                <div>
                    <button type="button" class="settings-accordion-button">
                        <span class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <div>
                                <span class="font-bold primary-text">Account Settings</span>
                                <p class="text-sm secondary-text font-normal">Update your credentials and email.</p>
                            </div>
                        </span>
                        <svg class="accordion-icon w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-accordion-panel">
                        <div class="space-y-4 pt-4">
                            <div>
                                <label for="userEmailAddress" class="block text-sm font-medium secondary-text mb-2">Email Address</label>
                                <input type="email" id="userEmailAddress" class="form-input w-full" placeholder="your.email@example.com">
                            </div>
                            <div>
                                <label for="currentPassword" class="block text-sm font-medium secondary-text mb-2">Current Password</label>
                                <input type="password" id="currentPassword" class="form-input w-full" placeholder="Enter current password">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium secondary-text mb-2">New Password (optional)</label>
                                <input type="password" id="newPassword" class="form-input w-full" placeholder="Enter new password">
                            </div>
                            <div>
                                <label for="confirmNewPassword" class="block text-sm font-medium secondary-text mb-2">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" class="form-input w-full" placeholder="Confirm new password">
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" onclick="saveAccountSettings()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Update Account Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 3: Email Notifications -->
                <div>
                    <button type="button" class="settings-accordion-button">
                        <span class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div>
                                <span class="font-bold primary-text">Email Notifications</span>
                                <p class="text-sm secondary-text font-normal">Configure your notification preferences.</p>
                            </div>
                        </span>
                        <svg class="accordion-icon w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-accordion-panel">
                        <div class="space-y-4 pt-4">
                            <div class="flex items-center justify-between">
                                <label for="emailNotificationsEnabled" class="block text-sm font-medium">Enable Email Notifications</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailNotificationsEnabled">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnFriendRequest" class="block text-sm font-medium">When receiving a friend request</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnFriendRequest">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnFriendAccept" class="block text-sm font-medium">When a friend request is accepted</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnFriendAccept">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnWallPost" class="block text-sm font-medium">When someone posts on your wall</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnWallPost">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnMention" class="block text-sm font-medium">When someone mentions you</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnMention">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnEventInvite" class="block text-sm font-medium">When you are invited to an event</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnEventInvite">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="emailOnEventUpdate" class="block text-sm font-medium">When an event is updated/cancelled</label>
                                <label class="theme-switch">
                                    <input type="checkbox" id="emailOnEventUpdate">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="flex justify-end gap-4">
                                <button type="button" onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Save Notification Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 4: Authorized Devices -->
                <div>
                    <button type="button" class="settings-accordion-button">
                        <span class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            <div>
                                <span class="font-bold primary-text">Authorized Devices</span>
                                <p class="text-sm secondary-text font-normal">Manage your logged-in devices.</p>
                            </div>
                        </span>
                        <svg class="accordion-icon w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="settings-accordion-panel">
                        <div class="space-y-4 pt-4">
                            <p class="text-sm secondary-text">This is a list of devices that have logged into your account. Revoke any sessions that you do not recognize.</p>
                            <div id="activeSessionsList" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="secondary-text">Loading sessions...</p>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" onclick="logoutAllSessions()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">
                                    Log Out All Other Devices
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-4 mt-6 border-t dark:border-gray-700 pt-4">
                <button type="button" onclick="closeModal('settingsModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Media Carousel Modal -->
    <div id="mediaCarouselModal" class="modal hidden">
        <span class="modal-close media-carousel-close">&times;</span>
        <a class="modal-nav-button left prev-button">&#10094;</a>
        <a class="modal-nav-button right next-button">&#10095;</a>
        <div class="modal-content-wrapper">
            <div class="media-carousel-display"></div>
            <p class="media-carousel-caption"></p>
            <div class="media-carousel-content"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="{{ url_for('static', filename='js/media_carousel.js') }}"></script>
    <script>
        window.appConfig = {
            isSpaPage: false,
            viewerToken: "{{ viewer_token or '' }}",
            isFederatedViewer: {{ 'true' if is_federated_viewer else 'false' }},
            viewer_home_url: "{{ viewer_home_url or '' }}",
            loggedInUsername: "{{ session.get('username') or ('' if not session.get('is_federated_viewer')) }}",
            loggedInUserPuid: "{{ viewer_puid or '' }}",
            isCurrentUserAdmin: {{ 'true' if session.get('is_admin') else 'false' }},
            browseMediaBaseUrl: "{{ url_for('main.browse_media', mode='multi_select') }}",
            serveMediaBaseUrl: "{{ url_for('main.serve_user_media', puid='DUMMY_PUID', filename='DUMMY_FILE') }}".replace('DUMMY_PUID/DUMMY_FILE', ''),
            localHostname: "{{ config.get('NODE_HOSTNAME') or request.host.split(':')[0] | js_string }}",
            userSettings: {
                textSize: {{ user_settings.text_size | default(100) }},
                timezone: {{ user_settings.timezone | tojson }},
                theme: "{{ user_settings.theme | default('light') }}",
                user_email_address: "{{ user_settings.user_email_address | default('') }}",
                email_notifications_enabled: "{{ user_settings.email_notifications_enabled }}" === 'True',
                email_on_friend_request: "{{ user_settings.email_on_friend_request }}" === 'True',
                email_on_friend_accept: "{{ user_settings.email_on_friend_accept }}" === 'True',
                email_on_wall_post: "{{ user_settings.email_on_wall_post }}" === 'True',
                email_on_mention: "{{ user_settings.email_on_mention }}" === 'True',
                email_on_event_invite: "{{ user_settings.email_on_event_invite }}" === 'True',
                email_on_event_update: "{{ user_settings.email_on_event_update }}" === 'True'
            },
            saveSettingsUrl: "{{ url_for('settings.update_settings') }}",
            saveAccountSettingsUrl: "{{ url_for('settings.update_account_credentials') }}",
            logoutUrl: "{{ url_for('auth.logout') }}",
            getSessionsUrl: "{{ url_for('settings.get_sessions') }}",
            logoutSessionUrlBase: "{{ url_for('settings.logout_session', session_id='DUMMY_ID') }}",
            logoutAllSessionsUrl: "{{ url_for('settings.logout_all_sessions') }}"
        };

        function openMediaBrowserForEventPicture() {
            sessionStorage.setItem('mediaBrowserMode', 'single_select');
            window.open(window.appConfig.browseMediaBaseUrl, '_blank', 'width=800,height=600');
        }

        // Media filtering functionality
        function filterMedia(type) {
            const allItems = document.querySelectorAll('.media-item');
            const buttons = document.querySelectorAll('.filter-button');
            
            // Update active button
            buttons.forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Filter items
            allItems.forEach(item => {
                if (type === 'all') {
                    item.style.display = 'block';
                } else if (type === 'images' && item.classList.contains('image-item')) {
                    item.style.display = 'block';
                } else if (type === 'videos' && item.classList.contains('video-item')) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Media carousel functionality
        const mediaItems = {{ all_media | tojson }};
        let currentMediaIndex = 0;

        function openMediaCarousel(index) {
            currentMediaIndex = index;
            showMediaInCarousel(index);
            document.getElementById('mediaCarouselModal').classList.remove('hidden');
        }

        function showMediaInCarousel(index) {
            if (!mediaItems || mediaItems.length === 0) return;
            
            const item = mediaItems[index];
            const displayDiv = document.querySelector('.media-carousel-display');
            const captionP = document.querySelector('.media-carousel-caption');
            const contentDiv = document.querySelector('.media-carousel-content');
            
            // Construct media URL using the federated media URL pattern
            let mediaUrl;
            if (item.origin_hostname) {
                const protocol = window.location.protocol;
                mediaUrl = `${protocol}//${item.origin_hostname}/user_media/${item.puid}/${item.media_file_path}`;
            } else {
                mediaUrl = `/user_media/${item.puid}/${item.media_file_path}`;
            }
            
            // Update display
            if (item.media_type === 'image') {
                displayDiv.innerHTML = `<img src="${mediaUrl}" alt="${item.alt_text}" style="max-width: 100%; max-height: 80vh;">`;
            } else {
                displayDiv.innerHTML = `<video controls style="max-width: 100%; max-height: 80vh;">
                    <source src="${mediaUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>`;
            }
            
            // Update caption
            captionP.textContent = `Posted by ${item.username} on ${item.timestamp}`;
            
            // Update content
            contentDiv.innerHTML = '';  // Event media doesn't have post content in this view
        }

        // Navigation
        document.querySelector('.prev-button').addEventListener('click', () => {
            currentMediaIndex = (currentMediaIndex - 1 + mediaItems.length) % mediaItems.length;
            showMediaInCarousel(currentMediaIndex);
        });

        document.querySelector('.next-button').addEventListener('click', () => {
            currentMediaIndex = (currentMediaIndex + 1) % mediaItems.length;
            showMediaInCarousel(currentMediaIndex);
        });

        // Close modal
        document.querySelector('.media-carousel-close').addEventListener('click', () => {
            document.getElementById('mediaCarouselModal').classList.add('hidden');
        });
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    
</body>
</html>