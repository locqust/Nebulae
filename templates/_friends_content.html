<!-- This file replaces the old friends.html. It only contains the main content. -->
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mb-4">
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- Wrapped friends content in a card for layout consistency -->
<div>
    
    <!-- Title for the page -->
    <h1 class="text-3xl font-bold primary-text mb-6">My Connections</h1>

    <!-- Tab Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav class="-mb-px flex space-x-2 sm:space-x-6" aria-label="Tabs">
            {# Friends/Followers Tab #}
            <button class="tab-button active py-4 px-2 sm:px-1 text-center font-medium text-base sm:text-lg secondary-text hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-2" onclick="switchConnectionTab('friends')" data-tab="friends">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="hidden sm:inline">
                    {% if profile_user.user_type == 'public_page' %}Followers{% else %}Friends{% endif %}
                    {% if friends %}
                        <span class="ml-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded-full text-xs font-semibold">{{ friends|length }}</span>
                    {% endif %}
                </span>
            </button>
            
            {# Pages Tab #}
            <button class="tab-button py-4 px-2 sm:px-1 text-center font-medium text-base sm:text-lg secondary-text hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-2" onclick="switchConnectionTab('pages')" data-tab="pages">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <span class="hidden sm:inline">
                    Pages
                    {% if followed_pages %}
                        <span class="ml-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded-full text-xs font-semibold">{{ followed_pages|length }}</span>
                    {% endif %}
                </span>
            </button>
            
            {% if profile_user.user_type != 'public_page' %}
            {# Requests Tab #}
            <button class="tab-button py-4 px-2 sm:px-1 text-center font-medium text-base sm:text-lg secondary-text hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-2" onclick="switchConnectionTab('requests')" data-tab="requests">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <span class="hidden sm:inline">
                    Requests
                    {% set total_requests = (pending_incoming_requests|length if pending_incoming_requests else 0) + (pending_outgoing_requests|length if pending_outgoing_requests else 0) %}
                    {% if total_requests > 0 %}
                        <span class="ml-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-0.5 rounded-full text-xs font-semibold">{{ total_requests }}</span>
                    {% endif %}
                </span>
            </button>
            
            {# Blocked Tab #}
            <button class="tab-button py-4 px-2 sm:px-1 text-center font-medium text-base sm:text-lg secondary-text hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-2" onclick="switchConnectionTab('blocked')" data-tab="blocked">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                <span class="hidden sm:inline">
                    Blocked
                    {% if blocked_friends %}
                        <span class="ml-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-2 py-0.5 rounded-full text-xs font-semibold">{{ blocked_friends|length }}</span>
                    {% endif %}
                </span>
            </button>
            {% endif %}
        </nav>
    </div>

    <!-- Search Bar (shows on Friends and Pages tabs) -->
    <div class="mb-6 connections-search-bar">
        <input type="search" id="connectionsSearchInput" placeholder="Search connections..." class="w-full px-4 py-3 border rounded-lg form-input" aria-label="Search connections">
    </div>

    <!-- "No search results" message -->
    <p id="no-search-results-message" class="text-center secondary-text py-4" style="display: none;"></p>

    <!-- ==================== TAB 1: FRIENDS ==================== -->
    <div id="friends-tab" class="connection-tab-content">
        {% if friends %}
            <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friends-list">
                {% for friend in friends %}
                    {% if not friend.is_blocked %}
                    {% set search_text = (friend.display_name or friend.username) | lower + ' ' + (friend.username) | lower %}
                    <li class="flex items-center justify-between p-4 rounded-lg shadow-sm border post-card connection-item" data-search-text="{{ search_text }}">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full overflow-hidden mr-4 border border-gray-300 dark:border-gray-600">
                                {% if friend.profile_picture_path %}
                                    {% set filename = friend.profile_picture_path %}
                                    {% set hostname = friend.hostname %}
                                    {% set protocol = 'http' if config.FEDERATION_INSECURE_MODE else 'https' %}
                                    
                                    {% if hostname %}
                                        <img src="{{ protocol }}://{{ hostname }}/profile_pictures/{{ filename }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% else %}
                                        <img src="{{ url_for('main.serve_profile_picture', filename=filename) }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% endif %}
                                {% else %}
                                    <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                {% endif %}
                            </div>
                            <div style="word-wrap: break-word; overflow-wrap: break-word;">
                                <a href="{{ url_for('main.user_profile', puid=friend.puid) }}" class="name-link text-lg" style="white-space: normal;">
                                    {{ friend.display_name if friend.display_name else friend.username }}
                                </a>
                                <div class="flex items-center space-x-2">
                                    {% if profile_user.user_type != 'public_page' %}
                                        <p class="text-sm secondary-text">Friends since: <span class="utc-timestamp" data-timestamp="{{ friend.established_at }}">{{ friend.established_at | format_timestamp }}</span></p>
                                    {% endif %}
                                    {% if friend.snooze_until %}
                                        <span class="text-xs bg-yellow-200 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-1 rounded-full">Snoozed</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative inline-block text-left">
                            <button onclick="toggleDropdown(event, 'dropdown-menu-friend-{{ friend.id }}')" 
                                    id="options-menu-friend-{{ friend.id }}"
                                    class="inline-flex justify-center w-full rounded-md px-2 py-1 text-sm font-medium secondary-text hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                </svg>
                            </button>
                            
                            <div id="dropdown-menu-friend-{{ friend.id }}" class="dropdown-menu" style="display: none;">
                                <div class="py-1">
                                    {% if friend.snooze_until %}
                                        <form action="{{ url_for('friends.unsnooze_friend_route', puid=friend.puid) }}" method="POST">
                                            <button type="submit" class="text-yellow-600 dark:text-yellow-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                                <span class="inline-flex items-center gap-2">
                                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                                    </svg>
                                                    <span>Unsnooze</span>
                                                </span>
                                            </button>
                                        </form>
                                    {% else %}
                                        <form action="{{ url_for('friends.snooze_friend_route', puid=friend.puid) }}" method="POST">
                                            <button type="submit" class="hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                                <span class="inline-flex items-center gap-2">
                                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                                    </svg>
                                                    <span>Snooze</span>
                                                </span>
                                            </button>
                                        </form>
                                    {% endif %}

                                    {% if friend.is_blocked %}
                                        <form action="{{ url_for('friends.unblock_friend_route', puid=friend.puid) }}" method="POST" onsubmit="event.preventDefault();">
                                            <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to unblock {{ friend.display_name or friend.username | js_string }}?')" class="text-green-600 dark:text-green-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                                <span class="inline-flex items-center gap-2">
                                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <span>Unblock</span>
                                                </span>
                                            </button>
                                        </form>
                                    {% else %}
                                        <form action="{{ url_for('friends.block_friend_route', puid=friend.puid) }}" method="POST" onsubmit="event.preventDefault();">
                                            <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to block {{ friend.display_name or friend.username | js_string }}?')" class="text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                                <span class="inline-flex items-center gap-2">
                                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                                                    </svg>
                                                    <span>Block</span>
                                                </span>
                                            </button>
                                        </form>
                                    {% endif %}

                                    <form method="post" action="{{ url_for('friends.unfriend_route', puid=friend.puid) }}" onsubmit="event.preventDefault();">
                                        <button type="button" onclick="confirmFormSubmission(this.closest('form'), 'Are you sure you want to unfriend {{ friend.display_name or friend.username | js_string }}?')" class="text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left px-4 py-2 text-sm">
                                            <span class="inline-flex items-center gap-2">
                                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                                                </svg>
                                                <span>Unfriend</span>
                                            </span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <p class="mt-4 text-lg secondary-text">
                    {% if profile_user.user_type == 'public_page' %}
                        You don't have any followers yet.
                    {% else %}
                        You don't have any friends yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>

    <!-- ==================== TAB 2: PAGES ==================== -->
    <div id="pages-tab" class="connection-tab-content hidden">
        {% if followed_pages %}
            <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="followed-pages-list">
                {% for page in followed_pages %}
                    {% set search_text = (page.display_name or page.username) | lower + ' ' + (page.username) | lower %}
                    <li class="flex items-center justify-between p-4 rounded-lg shadow-sm border post-card connection-item" id="followed-page-{{ page.puid }}" data-search-text="{{ search_text }}">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full overflow-hidden mr-4 border border-gray-300 dark:border-gray-600">
                                {% if page.profile_picture_path %}
                                    {% set filename = page.profile_picture_path %}
                                    {% set hostname = page.hostname %}
                                    {% set protocol = 'http' if config.FEDERATION_INSECURE_MODE else 'https' %}
                                    
                                    {% if hostname %}
                                        <img src="{{ protocol }}://{{ hostname }}/profile_pictures/{{ filename }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% else %}
                                        <img src="{{ url_for('main.serve_profile_picture', filename=filename) }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% endif %}
                                {% else %}
                                    <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd"></path>
                                    </svg>
                                {% endif %}
                            </div>
                            <div style="word-wrap: break-word; overflow-wrap: break-word;">
                                <a href="{{ url_for('main.user_profile', puid=page.puid) }}" class="name-link text-lg" style="white-space: normal;">
                                    {{ page.display_name if page.display_name else page.username }}
                                </a>
                            </div>
                        </div>
                        
                        <button type="button" onclick="unfollowPageFromList(this, '{{ page.puid }}')"
                                class="px-4 py-2 rounded-lg border transition-colors text-sm font-medium flex-shrink-0">
                            <span class="inline-flex items-center gap-2">
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                                </svg>
                                <span>Unfollow</span>
                            </span>
                        </button>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <p class="mt-4 text-lg secondary-text">You are not following any pages yet.</p>
            </div>
        {% endif %}
    </div>

    <!-- ==================== TAB 3: REQUESTS ==================== -->
    {% if profile_user.user_type != 'public_page' %}
    <div id="requests-tab" class="connection-tab-content hidden">
        <!-- Incoming Requests -->
        <div class="mb-8">
            <h2 class="text-xl font-bold primary-text mb-4">Incoming Requests</h2>
            {% if pending_incoming_requests %}
                <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="incoming-requests-list">
                    {% for request in pending_incoming_requests %}
                        <li class="flex items-center justify-between p-4 rounded-lg shadow-sm border post-card">
                            <div class="flex items-center flex-1">
                                <div class="w-12 h-12 flex-shrink-0 rounded-full overflow-hidden mr-4 border border-gray-300 dark:border-gray-600">
                                    {% if request.sender_profile_picture %}
                                        {% set filename = request.sender_profile_picture %}
                                        {% set hostname = request.sender_hostname %}
                                        {% set protocol = 'http' if config.FEDERATION_INSECURE_MODE else 'https' %}
                                        
                                        {% if hostname %}
                                            <img src="{{ protocol }}://{{ hostname }}/profile_pictures/{{ filename }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                        {% else %}
                                            <img src="{{ url_for('main.serve_profile_picture', filename=filename) }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                        {% endif %}
                                    {% else %}
                                        <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                    {% endif %}
                                </div>
                                <div>
                                    <a href="{{ url_for('main.user_profile', puid=request.sender_puid) }}" class="font-semibold primary-text text-lg name-link">{{ request.sender_display_name if request.sender_display_name else request.sender_username }}</a><span class="primary-text ml-1"> wants to be friends.</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <form method="post" action="{{ url_for('friends.accept_friend_request_route', request_id=request.id) }}" class="inline">
                                    <button type="submit" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium">
                                        Accept
                                    </button>
                                </form>
                                <form method="post" action="{{ url_for('friends.reject_friend_request_route', request_id=request.id) }}" class="inline">
                                    <button type="submit" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium">
                                        Decline
                                    </button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center py-8">
                    <p class="secondary-text">No incoming friend requests.</p>
                </div>
            {% endif %}
        </div>

        <!-- Outgoing Requests -->
        <div class="mb-8">
            <h2 class="text-xl font-bold primary-text mb-4">Outgoing Requests</h2>
            {% if pending_outgoing_requests %}
                <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="outgoing-requests-list">
                    {% for request in pending_outgoing_requests %}
                        <li class="flex items-center justify-between p-4 rounded-lg shadow-sm border post-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full overflow-hidden mr-4 border border-gray-300 dark:border-gray-600">
                                    {% if request.receiver_profile_picture %}
                                        {% set filename = request.receiver_profile_picture %}
                                        {% set hostname = request.receiver_hostname %}
                                        {% set protocol = 'http' if config.FEDERATION_INSECURE_MODE else 'https' %}
                                        
                                        {% if hostname %}
                                            <img src="{{ protocol }}://{{ hostname }}/profile_pictures/{{ filename }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                        {% else %}
                                            <img src="{{ url_for('main.serve_profile_picture', filename=filename) }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                        {% endif %}
                                    {% else %}
                                        <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="primary-text text-lg">Request sent to <a href="{{ url_for('main.user_profile', puid=request.receiver_puid) }}" class="font-semibold name-link">{{ request.receiver_display_name if request.receiver_display_name else request.receiver_username }}</a></span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="text-sm text-gray-500 dark:text-gray-400">Pending</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center py-8">
                    <p class="secondary-text">No outgoing friend requests.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ==================== TAB 4: BLOCKED ==================== -->
    {% if profile_user.user_type != 'public_page' %}
    <div id="blocked-tab" class="connection-tab-content hidden">
        {% if blocked_friends %}
            <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="blocked-friends-list">
                {% for blocked in blocked_friends %}
                    <li class="flex items-center justify-between p-4 rounded-lg shadow-sm border post-card">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full overflow-hidden mr-4 border border-gray-300 dark:border-gray-600">
                                {% if blocked.profile_picture_path %}
                                    {% set filename = blocked.profile_picture_path %}
                                    {% set hostname = blocked.hostname %}
                                    {% set protocol = 'http' if config.FEDERATION_INSECURE_MODE else 'https' %}
                                    
                                    {% if hostname %}
                                        <img src="{{ protocol }}://{{ hostname }}/profile_pictures/{{ filename }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% else %}
                                        <img src="{{ url_for('main.serve_profile_picture', filename=filename) }}" alt="Profile Picture" class="w-full h-full object-cover" onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'">
                                    {% endif %}
                                {% else %}
                                    <svg class="w-full h-full text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                {% endif %}
                            </div>
                            <div style="word-wrap: break-word; overflow-wrap: break-word;">
                                <p class="name-link text-lg" style="white-space: normal;">
                                    {{ blocked.display_name if blocked.display_name else blocked.username }}
                                </p>
                                <p class="text-sm secondary-text">Blocked since: <span class="utc-timestamp" data-timestamp="{{ blocked.blocked_at }}">{{ blocked.blocked_at | format_timestamp }}</span></p>
                            </div>
                        </div>
                        
                        <form method="post" action="{{ url_for('friends.unblock_friend_route', puid=blocked.puid) }}">
                            <button type="submit" 
                                    class="px-4 py-2 rounded-lg border border-green-600 bg-green-600 text-white hover:bg-green-700 transition-colors text-sm font-medium">
                                Unblock
                            </button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="mt-4 text-lg secondary-text">No blocked users.</p>
            </div>
        {% endif %}
    </div>
    {% endif %}

</div>

<!-- Initialize connections page functionality -->
<script>
// Initialize search functionality when this content loads
if (typeof initConnectionsSearch === 'function') {
    initConnectionsSearch();
}
</script>